
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-8.5.10">
    
    
      
        <title>Implementation considerations - ssb-clock-spec</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.472b142f.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.08040f6c.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="None" data-md-color-accent="None">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#implementation-considerations" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-component="outdated" hidden>
        
      </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="ssb-clock-spec" class="md-header__button md-logo" aria-label="ssb-clock-spec" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ssb-clock-spec
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Implementation considerations
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/gpicron/ssb-clock-spec" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="ssb-clock-spec" class="md-nav__button md-logo" aria-label="ssb-clock-spec" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    ssb-clock-spec
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/gpicron/ssb-clock-spec" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Introduction
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../01-design/" class="md-nav__link">
        Design
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Implementation considerations
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Implementation considerations
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#core-data-structures-and-algorithms" class="md-nav__link">
    Core data structures and algorithms
  </a>
  
    <nav class="md-nav" aria-label="Core data structures and algorithms">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bloom-clock-implementation" class="md-nav__link">
    Bloom clock implementation
  </a>
  
    <nav class="md-nav" aria-label="Bloom clock implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#comparebcs1bcs2" class="md-nav__link">
    compare(BCS1,BCS2)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#incrementbcs-hash-rof" class="md-nav__link">
    increment(BCS, hash, ROF)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#joinbcs1-bcs2" class="md-nav__link">
    join(BCS1, BCS2)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-dag" class="md-nav__link">
    The DAG
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-merkle-tree" class="md-nav__link">
    The Merkle Tree
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#protocol-specific-considerations" class="md-nav__link">
    Protocol-specific considerations
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#integration-with-ssb" class="md-nav__link">
    Integration with SSB
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deployment-and-maintenance" class="md-nav__link">
    Deployment and maintenance
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../03-maths/" class="md-nav__link">
        Maths and parameters
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../04-examples/" class="md-nav__link">
        Examples
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../05-security/" class="md-nav__link">
        Security considerations
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../06-open-issues/" class="md-nav__link">
        Open issues
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../99-references/" class="md-nav__link">
        References
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#core-data-structures-and-algorithms" class="md-nav__link">
    Core data structures and algorithms
  </a>
  
    <nav class="md-nav" aria-label="Core data structures and algorithms">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bloom-clock-implementation" class="md-nav__link">
    Bloom clock implementation
  </a>
  
    <nav class="md-nav" aria-label="Bloom clock implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#comparebcs1bcs2" class="md-nav__link">
    compare(BCS1,BCS2)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#incrementbcs-hash-rof" class="md-nav__link">
    increment(BCS, hash, ROF)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#joinbcs1-bcs2" class="md-nav__link">
    join(BCS1, BCS2)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-dag" class="md-nav__link">
    The DAG
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-merkle-tree" class="md-nav__link">
    The Merkle Tree
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#protocol-specific-considerations" class="md-nav__link">
    Protocol-specific considerations
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#integration-with-ssb" class="md-nav__link">
    Integration with SSB
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deployment-and-maintenance" class="md-nav__link">
    Deployment and maintenance
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  
  



  <a href="https://github.com/gpicron/ssb-clock-spec/edit/master/docs/02-implementation.md" title="Edit this page" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


<h1 id="implementation-considerations">Implementation considerations</h1>
<p>The "Implementation considerations" section of this design document discusses
the practical considerations that need to be taken into account when
implementing the protocols outlined in the previous sections.</p>
<h2 id="core-data-structures-and-algorithms">Core data structures and algorithms</h2>
<h3 id="bloom-clock-implementation">Bloom clock implementation</h3>
<p>The core data structure used in the protocols outlined in this design document
is the Bloom clock. The Bloom clock is a counting bloom filter data structure
that allows for the expression of causality between messages within a feed. It
consists of a counter array that is modified by the addition of elements, or 
hashes, representing events. The Bloom clock has two parameters, N and k, which
determine its size and the number of indices produced by the Random Oracle
Function (ROF), respectively.</p>
<p>The base rules for updating the Bloom clock are as follows:</p>
<ul>
<li>When an agent produces an update message (UM) on some identifiable entity (IE)
  with a current version BC(n), it produces a BC(n+1) by incrementing the k
  counters at the indices produced by the ROF(UM). The UM is added to the
  agent's
  feed along with BC(n+1) and the reference to the identifiable entity IE.</li>
<li>When an agent receives an update message UM with the Bloom clock BC(x) on some
  identifiable entity IE with a current version BC(n), it updates its knowledge
  about the IE and updates the version of the IE in its database to BC(n+1) = [
  max(BC(n)[i], BC(x)[i]) for i in 0..(N-1)].</li>
<li>The Bloom clock is useful for expressing the causality between events, or
  messages, in a distributed system. It is independent of the order of branches
  when merged, and supports efficient removal of events by keeping track of the
  hashes that were added to the Bloom clock. The Bloom clock can also be used to
  estimate the number of events that occurred between two events in a chain, and
  is encoded in a compact format to allow for efficient storage and
  transmission.</li>
</ul>
<p>The BloomClockStamp is encoded in a compact format to allow for efficient storage
and transmission, and can support different block sizes and formats to allow for
flexibility in the trade-off between size and computational effort.</p>
<p>The model of a BloomClockStamp is as follows:</p>
<ul>
<li>The BloomClockStamp is a counter array of length N, where N is a parameter 
  that determines the size of the BloomClockStamp.</li>
<li>The BloomClockStamp is initialized to all zeros.</li>
<li>When an event occurs, a hash is added to the BloomClockStamp by incrementing 
  the k indices produced by the Random Oracle Function (ROF) by 1.</li>
<li>The BloomClockStamps can be joined by setting each counter of the array to 
  the maximum of the two values.</li>
<li>The BloomClockStamp can be serialized into a compact byte representation for
  efficient storage and transmission.</li>
</ul>
<p>The encoding of a BloomClockStamp is as follows:</p>
<ul>
<li>The minimum value of the elements of the array is the base and is encoded 
  using a varint.</li>
<li>The increment from the base of elements of the vector of the vector are 
  encoded using bitpacking.</li>
<li>
<p>There are 3 parameters:</p>
</li>
<li>
<p>The bitpacked chunk size CZ and the number of chunks C such that the C * 
    CZ = N the size of the BloomClockStamp</p>
</li>
<li>The bitpacking format which determine the number of bits per chunk used 
    to specify the format of the chunk and the format of the chunks used.
    Consequently, it also inmplies the maximum range encodable between the 
    min and max elements of the array.  For instance, <ul>
<li>the format (1,2,4,8) use 2 bits per chunk to specify format of the 
  chunk and 1, 2, 4 or 8 bits to encode the elements of the chunk. The 
  max range is 256.</li>
<li>the format (0,1,2,8) use 2 bits per chunk to specify format of the
  chunk and 0, 1, 2 or 8 bits to encode the elements of the chunk. It 
  can be interesting for very large Bloom Clock with a small number of k 
  of hashes functions are it implies that most of the chunk will be all 
  zeros or very small.</li>
<li>the (0,1,2,4,8,16,24,32), will use 3 bits per chunk and allows to 
  encode a range of 2^32.</li>
<li>other formats may be invented on the same logic.</li>
</ul>
</li>
<li>Note: the chunk size must be a multiple of 32 so that the chunk </li>
</ul>
<p>So, at byte level, it is encoded as:
- 1 positive varint : the base
- A array of CZ n-bit integers representing the format of each chunks.
- 0-Padding at 32 bit
- Element Chunks encoded according the format.</p>
<p>There are 3 functions on BloomClockStamp:</p>
<h4 id="comparebcs1bcs2">compare(BCS1,BCS2)</h4>
<p>The compare function takes two BloomClockStamps as input and returns one of
four values:</p>
<ul>
<li>BCS_PRECEDES: If all elements of the first BloomClockStamp (BCS1) are
pairwise smaller or equal to all elements of the second BloomClockStamp
(BCS2), then it can be inferred that BCS1 occurred before BCS2.</li>
<li>BCS_SUCCEEDS: If all elements of BCS2 are pairwise smaller or equal to
all elements of BCS1, then it can be inferred that BCS2 occurred before BCS1.</li>
<li>BCS_EQUALS: If all elements of BCS1 are equal to all elements of BCS2,
then it can be inferred that BCS1 and BCS2 occurred at the same time.</li>
<li>BCS_FORKED: If none of the above conditions are met, then it can be
inferred that BCS1 and BCS2 are in separate branches after a fork.</li>
</ul>
<pre class="highlight"><code class="language-typescript">function compare(BCS1: BloomClockStamp, BCS2: BloomClockStamp): ComparisonResult {
  if (BCS1.length !== BCS2.length) {
    throw new Error("Cannot compare BloomClockStamps of different lengths");
  }

  let equal = true;
  let BCS1Precedes = false;
  let BCS2Precedes = false;
  for (let i = 0; i &lt; BCS1.length; i++) {
    if (BCS1[i] &lt; BCS2[i]) {
      BCS1Precedes = true;
      equal = false;
    } else if (BCS1[i] &gt; BCS2[i]) {
      BCS2Precedes = true;
      equal = false;
    }
  }

  if (equal) {
    return ComparisonResult.Equal;
  } else if (BCS1Precedes &amp;&amp; BCS2Precedes) {
    return ComparisonResult.Forked;
  } else if (BCS1Precedes) {
    return ComparisonResult.BCS1Precedes;
  } else {
    return ComparisonResult.BCS2Precedes;
  }
}

enum ComparisonResult {
  BCS1Precedes,
  BCS2Precedes,
  Equal,
  Forked
}
</code></pre>
<h4 id="incrementbcs-hash-rof">increment(BCS, hash, ROF)</h4>
<p>The increment function takes a BloomClockStamp (BCS) and a hash as input,
and returns a new BloomClockStamp that is the result of incrementing the k
counters at the indices produced by the ROF(hash).</p>
<pre class="highlight"><code class="language-typescript">function increment(BCS: BloomClockStamp, hash: Hash, ROF: RandomOracleFunction): BloomClockStamp {
  let indices = ROF(hash)  // compute indices to increment using the ROF function
  for (let i of indices) {
    BCS[i]++  // increment the counters at the computed indices
  }
  return BCS  // return the updated BloomClockStamp
}</code></pre>
<h4 id="joinbcs1-bcs2">join(BCS1, BCS2)</h4>
<p>The join function takes two BloomClockStamps (BCS1 and BCS2) as input, and
returns a new BloomClockStamp that is the result of setting each counter of
the array to the maximum of the two values.</p>
<pre class="highlight"><code class="language-typescript">function join(BCS1, BCS2) {
  // Initialize result BloomClockStamp to the same size as BCS1
  let result = new Array(BCS1.length)

  // Set each element of result to the maximum of the corresponding elements of BCS1 and BCS2
  for (let i = 0; i &lt; BCS1.length; i++) {
    result[i] = Math.max(BCS1[i], BCS2[i])
  }

  // Return the result
  return result
}</code></pre>
<h3 id="the-dag">The DAG</h3>
<p>A DAG (Directed Acyclic Graph) is a data structure used to represent the
causality between events in a distributed system. It consists of a set of
nodes, where each node represents an event and contains a reference to the
previous node in the chain. The DAG is a directed graph, meaning that the
edges connecting the nodes have a direction, and it is acyclic, meaning that
there are no cycles in the graph.</p>
<p>The model of a DAG is as follows:</p>
<ul>
<li>The DAG consists of a set of nodes, each node representing an event and
containing a reference to the previous node in the chain.
The DAG is a directed graph, meaning that the edges connecting the nodes
have a direction.</li>
<li>The DAG is acyclic, meaning that there are no cycles in the graph.</li>
<li>The DAG is useful for efficiently storing and querying the causality between
events in a distributed system. It allows for fast insertion and deletion of
nodes, and efficient querying of the relationship between nodes.</li>
</ul>
<p>Functions for inserting, deleting, and querying nodes in the DAG are
provided to facilitate the implementation of the ssb-clock feature. These
functions are described in more detail in the following sections.</p>
<pre class="highlight"><code>class DAG {
    private table: HashTable&lt;Hash, Node&gt;

    constructor() {
        this.table = new HashTable&lt;Hash, Node&gt;()
    }

    addNode(id: Hash, payload: Payload, parents: Hash[], ROF: RandomOracleFunction): void {
        let bcs = new BloomClockStamp()
        for (const parent of parents) {
          bcs = join(bcs, this.table.get(parent).stamp)
        }
        bcs = increment(bcs)
        const node = new Node(id, payload, parents, bcs)

        this.table.add(id, node)

    }

    getNode(id: string): Node | null {
        return this.table.get(id)
    }

    removeNode(id: string): void {
        this.table.remove(id)
    }
}

class Node {
    hash: string
    payload: Payload
    parents: string[]
    stamp: BloomClockStamp

    constructor(hash: Hash, payload: Payload, parents: string[], stamp: BloomClockStamp) {
        this.hash = hash
        this.payload = payload
        this.parents = parents
        this.stamp = stamp
    }
}
</code></pre>
<h3 id="the-merkle-tree">The Merkle Tree</h3>
<pre class="highlight"><code class="language-typescript">
function createMerkleTree(dagRoot: Node): MerkleTreeNode {
  let leafs = []
  let nextNode = dagRoot
  while (nextNode.hasChildren()) {
    const children = nextNode.getChildren()
    if (children.length &gt; 1) {
      let branchRoots = []

      children.sort()

      for (const child of children) {
        branchRoots.push(createMerkleTree(child))
      }

      leafs.push(createMerkleTreeFromLeaves(branchRoots))
    } else {
      let nextNode = children[0]
      leafs.push(new MerkleTreeNode(nextNode))
    }
  }

  return createMerkleTreeFromLeaves(branchHashes)
}
</code></pre>
<h2 id="protocol-specific-considerations">Protocol-specific considerations</h2>
<p>For each protocol, a description of any dependencies on other protocols or
components, such as the SSB core protocol or other synchronization protocols.</p>
<ul>
<li>A discussion of the data structures and algorithms used in the
  implementation of each protocol, such as the SELECT function for determining
  which peers are allowed to increment the counter.</li>
<li>Considerations for performance and scalability, such as the impact on
  network traffic and the ability to handle large numbers of concurrent updates.</li>
<li>A discussion of any security considerations, such as the potential for
  malicious actors to manipulate the global counter or attempt to cheat the
  proof of delay.</li>
</ul>
<h2 id="integration-with-ssb">Integration with SSB</h2>
<ul>
<li>A description of how the protocols fit into the overall architecture of SSB,
  including any modifications or extensions to the core protocol that may be
  required.</li>
<li>A discussion of any additional security measures that may be necessary when
  integrating the protocols with SSB, such as the use of cryptographic
  signatures or additional validation checks.</li>
</ul>
<h2 id="deployment-and-maintenance">Deployment and maintenance</h2>
<ul>
<li>A description of the process for deploying the protocols in a production
  environment, including any infrastructure or resources that will be required.</li>
<li>A discussion of any ongoing maintenance that will be needed, such as
  regular updates or the handling of bugs or issues that may arise.</li>
<li>A consideration of any potential challenges or issues that may arise during
  deployment or maintenance, such as the need to migrate data or coordinate
  updates across multiple peers.</li>
</ul>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../01-design/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Design" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Design
            </div>
          </div>
        </a>
      
      
        
        <a href="../03-maths/" class="md-footer__link md-footer__link--next" aria-label="Next: Maths and parameters" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Maths and parameters
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-consent" data-md-component="consent" id="__consent" hidden>
        <div class="md-consent__overlay"></div>
        <aside class="md-consent__inner">
          <form class="md-consent__form md-grid md-typeset" name="consent">
            


  
    
  



  


<h4>Cookie consent</h4>
<p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better.</p>
<input class="md-toggle" type="checkbox" id="__settings" >
<div class="md-consent__settings">
  <ul class="task-list">
    
      
      
        
        
      
      <li class="task-list-item">
        <label class="task-list-control">
          <input type="checkbox" name="github" checked>
          <span class="task-list-indicator"></span>
          GitHub
        <label>
      </li>
    
  </ul>
</div>
<div class="md-consent__controls">
  
    
      <button class="md-button md-button--primary">Accept</button>
    
    
    
  
    
    
    
      <label class="md-button" for="__settings">Manage settings</label>
    
  
</div>
          </form>
        </aside>
      </div>
      <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout(function(){document.querySelector("[data-md-component=consent]").hidden=!1},250);var action,form=document.forms.consent;for(action of["submit","reset"])form.addEventListener(action,function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);console.log(new FormData(form)),__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map(function(e){return[e,!0]}))),location.hash="",location.reload()})</script>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../assets/javascripts/bundle.d6c3db9e.min.js"></script>
      
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
      
        <script src="../javascripts/highlight.js"></script>
      
    
  </body>
</html>